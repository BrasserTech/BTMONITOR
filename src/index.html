<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>BTMonitor Desktop</title>
  <style>
    :root{
      --bg:#f7fafc; --panel:#ffffff; --muted:#5b6b7f; --text:#0f172a;
      --accent:#1d4ed8; --accent-soft:#e8efff; --info:#2563eb; --ship:#0891b2;
      --ok:#16a34a; --warn:#b45309; --border:#e5e7eb; --shadow:0 10px 25px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
      -webkit-font-smoothing:antialiased;font-smooth:always;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans"}
    .page{display:flex;flex-direction:column;min-height:100%}

    .topbar{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:#fff;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
    .brand{font-weight:800;letter-spacing:.2px;color:var(--accent)}
    .subtitle{color:var(--muted)}

    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;padding:20px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:var(--shadow)}
    .card-title{color:var(--muted);font-size:14px}
    .card-value{font-size:42px;font-weight:900;margin-top:8px;text-shadow:0 1px 0 rgba(29,78,216,.12)}
    .variant-total{border-top:4px solid var(--accent)}
    .variant-total .card-value{color:var(--accent)}
    .variant-preparo{border-top:4px solid var(--info); background:linear-gradient(0deg,#f4f8ff, #ffffff)}
    .variant-preparo .card-value{color:var(--info)}
    .variant-saida{border-top:4px solid var(--ship); background:linear-gradient(0deg,#f0fbff, #ffffff)}
    .variant-saida .card-value{color:var(--ship)}

    .table-wrap{padding:0 20px 24px}
    .table-title{margin:6px 0 10px;color:var(--muted)}
    table{width:100%;border-collapse:separate;border-spacing:0;background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden;box-shadow:var(--shadow)}
    th,td{padding:14px 16px;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle}
    thead th{color:#334155;background:var(--accent-soft);font-weight:700;border-bottom:1px solid #dbe4ff}
    tbody tr:hover{background:#f8fbff}
    tbody tr:last-child td{border-bottom:none}
    .subrow td{background:#f8fbff;border-top:1px solid #dbeafe}
    .muted{color:#64748b;font-size:12px;text-transform:uppercase;letter-spacing:.04em;margin-bottom:4px}
    .value-strong{font-weight:700}
    .qtd{text-align:center}

    .error{color:#b91c1c;font-weight:600}

    /* seletor de status com aparência de badge */
    .status-select{
      appearance:none;-webkit-appearance:none;-moz-appearance:none;
      border:1px solid rgba(37,99,235,.35); border-radius:999px; background:#eff6ff; color:#2563eb;
      padding:6px 28px 6px 12px; font-weight:700; font-size:12px; cursor:pointer;
    }
    .status-select:disabled{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <div class="page">
    <header class="topbar">
      <div class="brand">BTMonitor Desktop</div>
      <div class="subtitle">Painel de pedidos — Google Sheets</div>
    </header>

    <section class="kpis">
      <div class="card variant-total">
        <div class="card-title">Pedidos finalizados</div>
        <div id="kpi-total" class="card-value">0</div>
      </div>
      <div class="card variant-preparo">
        <div class="card-title">Em preparo</div>
        <div id="kpi-preparo" class="card-value">0</div>
      </div>
      <div class="card variant-saida">
        <div class="card-title">Saiu para entrega</div>
        <div id="kpi-saida" class="card-value">0</div>
      </div>
    </section>

    <section class="table-wrap">
      <div class="table-title">Fila de pedidos</div>
      <div id="info" class="table-title" style="display:none;color:#475569"></div>
      <table>
        <thead>
          <tr>
            <th>Hora</th>
            <th>Cliente</th>
            <th>Item</th>
            <th>Qtd</th>
            <th>Contato</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="tbody-pedidos"></tbody>
      </table>
      <div id="erro" class="table-title error" style="display:none;"></div>
    </section>
  </div>

  <script>
    // Parâmetros
    const APENAS_HOJE   = true;
    const MODO_DIA      = 'local';    // 'local' ou 'utc'
    const FALLBACK_ULTIMOS = 20;

    let dataset = [];

    // Helpers
    const safe = (v) => v && String(v).trim() ? v : '—';
    function isHojeLocal(iso){
      const d = new Date(iso || 0);
      return d.toDateString() === new Date().toDateString();
    }
    function isHojeUTC(iso){
      const s = String(iso || '');
      return s.slice(0,10) === new Date().toISOString().slice(0,10);
    }
    function filtraHoje(rows){
      const fn = (MODO_DIA === 'utc') ? isHojeUTC : isHojeLocal;
      return rows.filter(p => p.horaRaw && fn(p.horaRaw));
    }

    // Render
    function render(){
      const ordenado = [...dataset].sort((a,b) => new Date(b.horaRaw||0) - new Date(a.horaRaw||0));
      const doDia = filtraHoje(dataset);

      const finalizadosHoje = doDia.filter(p => p.status === 'Pronto').length;
      const emPreparoHoje   = doDia.filter(p => p.status === 'Em preparo').length;
      const saiuHoje        = doDia.filter(p => p.status === 'Saiu para entrega').length;

      document.getElementById('kpi-total').textContent   = finalizadosHoje;
      document.getElementById('kpi-preparo').textContent = emPreparoHoje;
      document.getElementById('kpi-saida').textContent   = saiuHoje;

      const apenasAndamento = (rows) => rows.filter(p => p.status !== 'Pronto');

      let visiveis = APENAS_HOJE ? apenasAndamento(filtraHoje(ordenado)) : apenasAndamento(ordenado);

      const info = document.getElementById('info');
      if (APENAS_HOJE && visiveis.length === 0) {
        visiveis = apenasAndamento(ordenado).slice(0, FALLBACK_ULTIMOS);
        if (info) {
          info.style.display = 'block';
          info.textContent = `Nenhum pedido em andamento hoje (${MODO_DIA.toUpperCase()}). Exibindo os ${FALLBACK_ULTIMOS} mais recentes em andamento.`;
        }
      } else if (info) {
        info.style.display = 'none';
        info.textContent = '';
      }

      const tbody = document.getElementById('tbody-pedidos');
      tbody.innerHTML = '';
      visiveis.forEach((p) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${safe(p.hora)}</td>
          <td>${safe(p.cliente)}</td>
          <td>${safe(p.item)}</td>
          <td class="qtd">${safe(p.qtd)}</td>
          <td>${safe(p.contato)}</td>
          <td>
            <select class="status-select" data-row="${p.rowNumber}" data-title="${p.sheetTitle||''}">
              <option value="1" ${p.statusCode==='1'?'selected':''}>Em preparo</option>
              <option value="2" ${p.statusCode==='2'?'selected':''}>Saiu para entrega</option>
              <option value="3" ${p.statusCode==='3'?'selected':''}>Pronto</option>
            </select>
          </td>
        `;
        tbody.appendChild(tr);

        const tr2 = document.createElement('tr');
        tr2.className = 'subrow';
        tr2.innerHTML = `
          <td colspan="6">
            <div style="display:grid;grid-template-columns:2fr 2fr 1fr;gap:16px">
              <div>
                <div class="muted">Endereço</div>
                <div class="value-strong">${safe(p.local)}</div>
              </div>
              <div>
                <div class="muted">Observação</div>
                <div class="value-strong">${safe(p.observacao)}</div>
              </div>
              <div>
                <div class="muted">Valor total</div>
                <div class="value-strong">${safe(p.valor)}</div>
              </div>
            </div>
          </td>
        `;
        tbody.appendChild(tr2);
      });
    }

    // Atualização de status
    async function onChangeStatus(e){
      if (!e.target.matches('.status-select')) return;
      const el = e.target;
      const row = Number(el.dataset.row);
      const title = el.dataset.title || '';
      const newCode = String(el.value);

      el.disabled = true;
      try{
        if (!window.api || typeof window.api.updateStatus !== 'function') {
          throw new Error('Bridge do preload indisponível (updateStatus).');
        }
        const resp = await window.api.updateStatus(row, newCode, title);
        if (!resp?.ok) throw new Error(resp?.error || 'Falha ao atualizar status.');

        const idx = dataset.findIndex(p => p.rowNumber === row);
        if (idx >= 0) {
          dataset[idx].statusCode = newCode;
          dataset[idx].status = (newCode==='1' ? 'Em preparo' : newCode==='2' ? 'Saiu para entrega' : 'Pronto');
        }
        render();
      } catch(err){
        const elErro = document.getElementById('erro');
        elErro.textContent = `Erro ao atualizar status: ${err?.message || err}`;
        elErro.style.display = 'block';
      } finally {
        el.disabled = false;
      }
    }

    // Carregar dados
    async function carregar(){
      const elErro = document.getElementById('erro');
      elErro.style.display = 'none';
      try {
        if (!window.api || typeof window.api.getPedidos !== 'function') {
          throw new Error('Bridge do preload indisponível (getPedidos). Verifique src/preload.js e webPreferences.preload.');
        }
        const res = await window.api.getPedidos();
        if (res?.ok) dataset = Array.isArray(res.data) ? res.data : [];
        else throw new Error(res?.error || 'Falha ao carregar planilha');
      } catch (e) {
        elErro.textContent = `Erro no renderer: ${e?.message || e}`;
        elErro.style.display = 'block';
      }
      render();
    }

    document.getElementById('tbody-pedidos').addEventListener('change', onChangeStatus);
    carregar();
    setInterval(carregar, 10000);
  </script>
</body>
</html>
